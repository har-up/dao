## 安卓应用简洁
根据开发方式的不同，安卓应用大致可分为三种
- web应用
- 原生应用
- 混合应用

### web应用
web应用是通过使用javascript、html5等web技术来实现交互，导航以及个性化功能的。web应用可以在移动设备的web浏览器中运行，并通过向后台服务器请求web页面来进行渲染。
一个应用可以有浏览器渲染的版本，也可以有作为独立应用的版本，这种现象很常见，因为这样可以避免重复开发

### 原生应用
不同于web应用，原生应用具有优良的性能和高度的可靠性。原生应用不需要从服务器获取支持，而且还能利用安卓系统提供的告诉本地支持，所以原生应用的响应速度很快。
且用户不连接网络也能使用某些应用。但是，使用原声技术开发的应用不能够跨平台，只能使用某一特定平台进行开发。所以，一些企业开始寻求能够避免重复工作的跨平台移动开发解决方案。

### 混合应用
混合应用尝试综合利用原生应用和web应用的优点，使用web技术编写，像原生应用一样在设备上运行。混合应用在原生容器中运行，利用设备的浏览器引擎在本地渲染html，并处理
javascript。混合应用能够通过一个web应用到原生应用的抽象层访问设备上的接口，如加速器、摄像头以及本地存储等，而web应用则不能访问这些接口。混合应用通常使用
photoGap、React Native等框架进行开发。一些企业则开发了自己的容器，比如阿里的weex，dcloud的uni-app

## 理解应用攻击面
应用开发出来后，我们需要提高应用架构各个层面的安全性

社交类、银行类、娱乐类等移动应用具有很多需要使用网络通信的功能，所以，如今的大部分移动应用都采用了常见的客户端-服务器架构。
想要了解这类应用的攻击面，需要充分考虑应用的各个方面，包括客户端、后端API、服务器漏洞以及数据库等。这些地方的任何一个入口都有可能对整个应用或应用数据造成威胁。

在软件开发时，建议遵循安全软件开发生命周期SDLC流程，从而保证软件开发生命周期中的每一个阶段的安全性。
安全软件开发生命周期能够帮助企业从流程的开始就考虑到产品的安全性，而不是在开发完成之后再考虑安全性。遵循安全软件开发生命周期能够降低维护阶段解决问题的成本，提高利润。
在安全软件开发生命周期中国，企业进行安全检查的方式各有不同，而且他们的成熟度也不一样。对于想要采用这一方法的企业来说，推荐一个不错的流程：
- 威胁建模
  通过界定资源、所提供的的述职以及可能攻击资源的威胁着来识别应用的威胁，最好在应用的设计阶段构建威胁模型。

- 静态分析
  在实现阶段，建议在每个发行周期对源代码至少进行一次静态分析。这样能让利益相关者了解风险的基本情况，便于他们决定是接受这些风险，还是让开发团队在应用正式发布前修复这些问题。

- 动态分析
  动态分析师在安全软件开发生命周期的测试阶段完成的。动态分析是一种在应用运行过程中查找问题的技术，能够帮助企业在发布应用前了解应用的安全情况。将在后续的章节里边
  介绍动态分析，如何进行动态分析。

## 客户端存在的威胁

- 静态应用数据
  随着移动应用的出现，在客户端存储数据的概念被广泛采用。很多移动应用在设备上存储未经加密的敏感数据，这是移动应用存在的主要问题之一。
  这些数据可能是敏感的、几米的、或者是私人的。
  有很多方法可以利用设备上的数据，拥有设备物理访问权限的攻击者集合可以轻而易举地窃取这些数据。如果设备已经root过了或者越狱了，那么恶意应用就可能窃取这些数据。
  所以，我们必须要确保应用不再设备上存储用户名、密码、认证标记、信用卡号码等敏感数据。如果不得不存储这些数据，就必须将其加密，谨防被攻击这窃取。

- 传输中的应用数据
  需要与后台进行通信的移动应用极易受到攻击，攻击者想要窃取传输中的数据。终端用户经常连接咖啡厅和机场的公用网络，而此时攻击者就可能使用burp代理、mitm代理、ssl 需要与后台进行通信的移动应用极易受到攻击，攻击者想要窃取传输中的数据。终端用户经常连接咖啡厅和机场的公用网络，而此时攻击者就可能使用burp代理、mitm代理、ssl
  等工具窃取数据。随着只能手机应用的使用，进行这类攻击已经变得非常容易，因为无论在哪里，我们都会随身携带手机

- 代码漏洞
  不具有安全措施的移动应用在遭受到各种攻击时会变得脆弱不堪。应用中的编码错误会导致严重的漏洞，进而影响用户数据和应用数据安全。这些失误的例子包括导出的内容提供者
  、导出的activity、客户端注入等等。攻击场景包括拥有设备物理访问权限的攻击者可能窃取一个用户的会话，设备中的恶意应用可以读取其他应用中由于编码错误而暴露的数据，能访问
  应用二进制数据的攻击者可能会对引用进行反编译，从而查看源代码中硬编码的证书。

- 应用数据泄漏
  几乎所有平台的移动应用都存在这个问题。应用可能会无意间将敏感数据泄露给攻击者，开发者需要格外注意这一点。开发人员需要移除在开发阶段中用于打印日志的代码，还必须
  保证没有容易泄漏的数据。这是因为应用沙盒不适合用于这一类型中的某些攻击。譬如、用户从应用中复制了像安全问题答案之类的敏感数据，这些数据就会被存放在设备的剪贴板上，
  而剪贴板并不在沙盒中。设备上的其他应用不需要知道之前的应用，就可以读取这些数据。

- 平台问题
  为移动应用设计威胁模型时，考虑针对该应用运行平台的威胁很重要。以安卓平台为例，面向安卓平台开发的原生应用就很容易被反编译，而且很容易查看java源代码，这样，攻击者就能查看应用
  的源代码以及代码中被硬编码的敏感数据。此外，攻击者还能修改应用代码，然后重新编译，并把应用发布到第三方应用市场上。如果应用是敏感应用或者付费应用，那么就必须
  对引用进行完整性检查。虽然上述问题对ios这样的系统影响相对较小，但如果设备越狱了，那么也会存在系统方面的问题。

## 后端存在的威胁
web服务和web应用很类似，web应用中存在的所有漏洞能够影响web服务。开发移动应用api时要牢记这一点。下面是api中一些常见的问题。

- 身份验证与授权
  在后端API开发中，开发人员经常创建自定义身份验证。在身份验证与授权中可能存在与之相关的漏洞。

- 会话管理
  移动平台通常使用身份验证令牌来管理会话。用户首次登录，会得到一个身份验证令牌，这个令牌在接下来的会话中都会用到。如果身份验证令牌在销毁前没有得到妥善保护，
  这就有可能导致一次攻击。只在客户端结束会话，而服务器没有结束会话，这是移动应用的另一个常见的问题。

- 输入验证
  输入验证是应用中已知的常见问题。如果不进行输入验证，可能会存在sql注入、命令注入以及跨站脚本攻击等风险。

- 错误处理不当
  应用错误对攻击者很有吸引力。如果错误处理不当，而API针对特定的请求抛出数据库异常或服务器异常，那么攻击者就可能利用这些错误进行巧妙的攻击。

- 脆弱的加密方法
  加密是开发者在开发过程中另一个经常犯错的地方。虽然各个平台都支持通过加密的方法保证数据安全，但密钥管理是客户端存在的主要问题。同样，也需要安全的存储后台数据。

- 数据库攻击
  攻击者有可能在未经授权的情况下直接访问数据库。如果没有强认证保护，攻击者就有可能在未经授权情况下访问phpMyAdmin等工具数据库控制台，另一个例子就是访问未授权
  的MongoDb控制台，因为MongoDB默认不需要任何认证就能访问它的控制。

## 移动应用测试与安全指南
很多企业都提供了移动应用测试与安全指南，其中最常用的指南包括OWASP移动应用十大风险和Veracode移动应用十大风险等。此外，googel公司也有自己的指南，以实例的形式
阐明在安卓应用安全中不应该做哪些。了解这些指南对于理解渗透测试很重要。

### OWASP移动应用十大风险（2014）

#### 弱服务器端控制
指的是针对应用后台的攻击。目前，大多数应用都是用网络连接，并通过REST 或者 SOAP API接口来连接后台服务器。移动应用的安全原则和传统web服务器以及web应用的安全原则
相同，因为我们只是是用了不同的前端，而后端还是相同的。常见的攻击向量包括找出暴露的API入口，查找各种漏洞，利用配置错误的服务器等。几乎所有的传统的OWASP十大漏洞都存在这种情况。

#### 不安全的数据存储
开发者会假定攻击者无法访问所有存储在设备文件系统上的数据。基于这一假设，开发者通常会通过共享首选项或者sqlite数据库将敏感信息存放在设备的文件系统中，比如用户名
身份验证令牌、密码、PIN码、生日以及住址等个人信息。有很多方法可以访问存储在设备本地的数据。常见的技术包括root设备，然后访问这些数据，或者使用基于备份文件的攻击等

### 传输层保护不足
和web应用相似，移动应用可能通过不安全的网络传输敏感信息、引发严重的攻击。人们经常在咖啡店和机场连接开发的wifi，恶意攻击者可以通过中间人攻击来窃取连接这些网络的用户的敏感
身份验证令牌、密码、PIN码、生日以及住址等个人信息。有很多方法可以访问存储在设备本地的数据。常见的技术包括root设备，然后访问这些数据，或者使用基于备份文件的攻击等

对移动应用进行渗透测试时，通常会通过网络传递证书和会话令牌。所以，我们可以通过分析流量来检查应用是否通过网络传输了敏感数据，这是一个不错的方法。还有一个重要的情况是
应用的大部分模块都是易受攻击的。如果应用需要通过https进行认证，并通过http发送认证cookies，那么这个应用就容易受到攻击，因为攻击者很容易获取通过http传递的认证cookies
而这些cookies与用户名和密码一样强大，都可以登录应用。缺乏证书认证和弱握手协议也是传输层安全协议中常见的问题。

### 意外的数据泄漏
应用输入用户的敏感信息存放到设备中的一个不安全位置上，那么其他恶意应用就有可能访问这个不安全的位置，最终是设备处于高风险之中。
下面是可能导致数据泄漏的几种情形：
- 内容提供程序泄漏
- 复制与粘贴缓存
- 调试日志
- URL缓存
- 浏览器cookies
- 发送给第三方的分析数据

### 糟糕的授权和身份认证
基于实用性的考量，移动应用的认证与传统的web认证方案也不相同。如果没有采取响应的措施，攻击者很容易就能暴力破解应用中这些较短的pin码。
我们可以向服务器发送恶意的请求，并观察这些请求是否得到响应来尝试访问应用更高权限的功能，这样就可以测试糟糕的授权方案

### 被破解的加密技术
在应用中使用加密技术，就会设计加密技术破解的问题。OWASP移动应用十大风险中提到了下面两个主要原因
- 使用较弱的算法来进行加密和解密：包括使用有重大漏洞的算法或者不满足现代安全要求，比如DES，3des等
- 使用强加密算法，但实现方式不安全：包括在本地数据库存储密钥，将密钥硬编码到代码中

### 客户端注入
通过恶意注入，可以在应用在移动设备上执行恶意代码。通常，恶意代码通过不同的方式借助威胁代理输入到移动应用中
下面是一些客户端注入的例子
- webview注入
- 通过原始sql语句对sqlite数据库进行传统的sql注入
- 内容提供者sql注入
- 内容提供程序路径遍历。

### 通过不受信任的输入进行安全决策
开发者需要注意是否存在未授权的用户可以通过不正确的输入过度使用了应用的敏感功能。攻击者可以拦截调用，并篡改其中的敏感参数，不关注这类功能就会导致应用产生错误，
甚至让攻击者获得更高的权限。使用不正确的Intent调用敏感的activity就是例子之一。

### 会话处理不当
移动应用市容注入soap或rest一类的协议来连接服务器。他们都是无状态协议，当移动应用使用这些协议时，客户端会在身份验证完成后从服务器获得一个令牌。用户在会话期间将会使用
这个令牌，OWASP的“会话处理不当”就是指攻击和保护这些会话。这个令牌在客户端失效后，却没有在服务器上失效，这是移动应用的一个常见问题。
通常，应用得到令牌后会通过共享首选项或sqlite数据库来存储。一旦恶意用户获得了这个令牌，而服务器没有即使让这个令牌失效，那么他就可以随时使用这个令牌。
其他可能出现的情况包括会话超时、弱令牌创建以及过期令牌等。

### 缺乏二进制文件保护
逆向工程是大部分安卓应用最常见的问题之一。攻击者得到应用的二进制文件后，首先会反编译或者拆解这个应用。攻击者通过这种方式可以查看硬编码的密钥，查找漏洞，甚至
通过重新打包拆解后的应用来修改应用的功能。虽然混淆源代码并不难，但是大部分的应用并没有这么做。如果没有对源代码进行混淆，攻击者只需要使用一个合适的工具就能完成
这些工作，比如apktool或dex2jar。虽然有些应用会检测设备的root状态，但是通过对应用进行逆向工程或者hook应用流程就能绕开这些检测。

## 自动化工具
Drozer和Quark是两款可能会在安卓应用评估中使用到的工具

### Drozer
根据Drozer的官方文档介绍：Drozer可以把你当做一款安卓应用，通过安卓的进程间通信机制和操作系统与其他应用进行交互。
不同于普通的自动化扫描器，Drozer是交互式的。用户使用Drozer进行安全评估时，需要在工作站控制台运行命令，然后Drozer把这些命令发送给设备的代理
进而执行相关的任务。

### 使用Drozer进行安卓安全评估
这一部分介绍如何使用drozer进行安全评估，并通过举例说明的形式介绍如何利用导出的activity漏洞。

- 安装测试应用，连接drozer

- 列出所有模块
  ```shell
  dz> list
  ```
  该命令可以列出drozer在当前会话中能够执行的全部模块
  ```shell
  app.activity.forintent       Find activities that can handle the given intent
  app.activity.info            Gets information about exported activities.
  app.activity.start           Start an Activity
  app.broadcast.info           Get information about broadcast receivers
  app.broadcast.send           Send broadcast using an intent
  app.broadcast.sniff          Register a broadcast receiver that can sniff
                               particular intents
  app.package.attacksurface    Get attack surface of package
  app.package.backup           Lists packages that use the backup API (returns true
                               on FLAG_ALLOW_BACKUP)
  app.package.debuggable       Find debuggable packages
  app.package.info             Get information about installed packages
  app.package.launchintent     Get launch intent of package
  app.package.list             List Packages
  app.package.manifest         Get AndroidManifest.xml of package
  app.package.native           Find Native libraries embedded in the application.
  app.package.shareduid        Look for packages with shared UIDs
  app.provider.columns         List columns in content provider
  app.provider.delete          Delete from a content provider
  app.provider.download        Download a file from a content provider that supports
                               files
  app.provider.finduri         Find referenced content URIs in a package
  app.provider.info            Get information about exported content providers
  app.provider.insert          Insert into a Content Provider
  app.provider.query           Query a content provider
  app.provider.read            Read from a content provider that supports files
  app.provider.update          Update a record in a content provider
  app.service.info             Get information about exported services
  app.service.send             Send a Message to a service, and display the reply
  app.service.start            Start Service
  app.service.stop             Stop Service   
  ```

- 检索软件包信息
  ```shell
  dz> run app.package.list
  dz> run app.package.list -f [过滤字符]
  dz> run app.package.info -a [包名]
  ```
  run app.package.info -a [包名]执行后，我们可以看到这个应用的很多信息，应用数据在文件系统中的存放路径、apk路径、是否存在共享用户名，权限等等。

## 识别攻击面
我们可以通过一个简单的命令就能识别出目标应用的攻击面。它能提供很多细节，比如应用组件是否是导出的，应用是否可以调试。

```shell
dz> run app.package.attacksurface [包名]
```
该命令会列出所有导出的四大组件以及应用是否可以调试。
当然，我们还可以找出导出的组件

### 攻击导出的activity
- 列出所有activity
  ```shell
  run app.activity.info -a [packagename]
  ```

- 启动activity
  ```shell
  run app.activity.start --component [packagename] [component name]
  ```

## QARK
根据官方的介绍，qark是一款静态代码分析工具，可以识别潜在的安全漏洞以及使用java开发安卓应用时的注意事项。
QARK是基于社区设计的，并且人人都能够免费使用。QARK能够将安卓应用的潜在安全风险告知开发者以及信息安全人员，详细描述各种问题，并且提供权威参考资料链接。